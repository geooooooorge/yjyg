# ✅ Upstash 配置文件已创建完成

## 📁 已创建的文件

我为你创建了以下文件来帮助你配置和使用 Upstash Redis：

### 1. `.env.example` - 环境变量示例文件
包含所有需要的环境变量模板，你需要复制它为 `.env.local` 并填入实际值。

### 2. `UPSTASH_SETUP.md` - 详细配置指南
完整的分步指南，包括：
- 如何创建 Upstash Redis 数据库
- 如何获取连接信息
- 如何配置环境变量
- 如何查看存储的数据
- 常见问题解答

### 3. `QUICK_START.md` - 5分钟快速开始
精简版指南，让你快速上手：
- 5个步骤完成配置
- 测试连接
- 验证数据存储

### 4. `setup-env.bat` - Windows 配置助手脚本
一键式配置脚本：
- 自动复制 `.env.example` 到 `.env.local`
- 提供配置步骤提示
- 自动打开文件进行编辑

### 5. `test-upstash.js` - 连接测试脚本
用于验证 Upstash 配置是否正确：
- 测试连接
- 测试读写操作
- 显示数据库中的 keys

### 6. 更新的 `README.md`
已将文档中的 Vercel KV 更新为 Upstash Redis。

### 7. 更新的 `package.json`
- 添加了 `dotenv` 依赖
- 添加了 `test:upstash` 测试命令

---

## 🎯 接下来你需要做什么

### 步骤 1️⃣：创建 Upstash 数据库

1. 访问 **https://console.upstash.com/**
2. 注册/登录（免费）
3. 点击 "Create Database"
4. 配置：
   - Name: `earnings-tracker`
   - Type: `Regional`（免费）
   - Region: `ap-southeast-1`（新加坡）或其他亚洲区域
5. 点击 "Create"

### 步骤 2️⃣：获取连接信息

在数据库详情页面：
1. 找到 **REST API** 部分
2. 复制 `UPSTASH_REDIS_REST_URL`（类似：`https://xxxxx.upstash.io`）
3. 复制 `UPSTASH_REDIS_REST_TOKEN`（一串长字符串）

### 步骤 3️⃣：配置本地环境

**方法 A：使用配置助手（推荐）**
```bash
setup-env.bat
```

**方法 B：手动配置**
```bash
# 1. 复制示例文件
copy .env.example .env.local

# 2. 编辑 .env.local，填入你的 Upstash 配置
notepad .env.local
```

在 `.env.local` 中填入：
```env
UPSTASH_REDIS_REST_URL=https://你的实际URL.upstash.io
UPSTASH_REDIS_REST_TOKEN=你的实际Token
```

### 步骤 4️⃣：安装依赖并测试

```bash
# 安装新依赖
npm install

# 测试 Upstash 连接
npm run test:upstash
```

看到 `✅ 所有测试通过！` 就说明配置成功了！

### 步骤 5️⃣：启动应用

```bash
npm run dev
```

访问 http://localhost:3000

---

## 🔍 如何查看存储的数据

### 在 Upstash 控制台查看（最简单）

1. 访问 https://console.upstash.com/
2. 选择你的数据库
3. 点击左侧 "Data Browser" 或 "CLI"
4. 输入以下命令：

```redis
# 查看所有存储的 keys
KEYS *

# 查看邮件订阅列表
GET email_list

# 查看所有历史股票数据
GET all_stocks_history

# 查看已发送的股票记录
KEYS sent_stocks:*

# 查看今天的新增股票
KEYS daily_new_stocks:*

# 查看邮件发送历史
GET email_history
```

---

## 📊 项目中使用 Upstash 存储的数据

| 数据类型 | Key 名称 | 说明 | 过期时间 |
|---------|---------|------|---------|
| 邮件订阅列表 | `email_list` | 所有订阅用户的邮箱 | 永久 |
| 已发送记录 | `sent_stocks:{code}:{quarter}` | 防止重复发送 | 90天 |
| 股票缓存 | `stocks_cache` | 临时缓存 | 5分钟 |
| 历史数据 | `all_stocks_history` | 所有历史股票数据 | 永久 |
| 发送历史 | `email_history` | 邮件发送记录 | 永久 |
| 每日新增 | `daily_new_stocks:{date}` | 按日期存储 | 永久 |
| 应用设置 | `app_settings` | 配置信息 | 永久 |

---

## ❓ 常见问题

### Q1: 为什么我在 Upstash 控制台看不到数据？

**A:** 可能的原因：
1. **数据库确实是空的** - 你还没有使用应用的功能
2. **选错了数据库** - 确认选择了正确的数据库
3. **应用使用了内存存储** - 检查环境变量配置

**解决方法**：
1. 在应用中添加一个邮箱
2. 点击"刷新数据"按钮
3. 返回 Upstash 控制台，刷新 Data Browser
4. 执行 `KEYS *` 查看是否有数据

### Q2: 启动时看到 "using memory storage" 警告？

**A:** 这说明环境变量没有正确配置。

**解决方法**：
1. 确认 `.env.local` 文件存在于项目根目录
2. 检查文件中的变量名是否正确（不要有拼写错误）
3. 确保没有多余的空格或引号
4. 重启开发服务器（Ctrl+C 然后重新 `npm run dev`）

### Q3: test:upstash 测试失败？

**A:** 可能的原因：
1. URL 或 Token 复制不完整
2. Upstash 数据库未激活
3. 网络连接问题

**解决方法**：
1. 重新从 Upstash 控制台复制 URL 和 Token
2. 确认数据库状态为 "Active"
3. 检查网络连接

---

## 🎉 配置成功的标志

当你正确配置后，应该看到：

### 1. 终端输出
```
✅ Upstash Redis initialized
✅ Settings API: Upstash Redis initialized
```

### 2. 测试脚本输出
```
✅ 所有测试通过！Upstash Redis 连接正常！
```

### 3. Upstash 控制台
- 可以看到数据库的 keys
- 可以读取存储的数据
- 数据库使用量增加

---

## 📚 相关文档

- **快速开始**：[QUICK_START.md](./QUICK_START.md)
- **详细指南**：[UPSTASH_SETUP.md](./UPSTASH_SETUP.md)
- **项目文档**：[README.md](./README.md)
- **Upstash 官方文档**：https://docs.upstash.com/

---

## 💡 提示

1. **免费额度**：Upstash 免费版提供 10,000 命令/天，256 MB 存储，对这个项目完全够用
2. **数据安全**：`.env.local` 已被 gitignore，不会被提交到 Git
3. **部署到 Vercel**：在 Vercel 项目设置中添加相同的环境变量即可

---

如果还有问题，请查看详细文档或检查终端的错误信息！
