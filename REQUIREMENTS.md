# 📋 业绩预增跟踪器 - 项目需求文档

---

## 📌 项目基本信息

### 项目名称
**业绩预增跟踪器 (Earnings Tracker)**

### 项目简介
自动跟踪东方财富业绩预增数据，发现新的业绩预增公告后自动发送邮件通知订阅用户。

### 项目类型
- [x] 数据监控系统
- [x] 订阅通知系统
- [x] 数据展示平台

### 目标用户
- 股票投资者
- 需要及时获取业绩预增信息的个人投资者
- 对特定股票业绩变化感兴趣的订阅者
- 需要自动化监控业绩公告的用户

---

## 🎯 核心需求

### 1. 主要功能

#### 功能 1：邮件订阅管理
**描述**：用户可以添加或删除邮箱地址，订阅业绩预增公告通知。

**用户故事**：
- 作为投资者，我想要添加我的邮箱到订阅列表，以便接收业绩预增通知
- 作为用户，我想要删除不再使用的邮箱，以便停止接收通知
- 作为用户，我想要看到当前所有订阅邮箱，以便管理我的订阅

**优先级**：
- [x] P0 - 必须有

**实现细节**：
- 邮箱格式验证
- 防止重复添加
- 支持多个邮箱订阅
- 数据持久化存储

---

#### 功能 2：股票数据展示
**描述**：在首页展示近7天的业绩预增公告，按季度分组，显示关键信息。

**用户故事**：
- 作为用户，我想要看到最新的业绩预增公告，以便了解市场动态
- 作为用户，我想要按季度查看数据，以便更好地组织信息
- 作为用户，我想要点击查看完整公告，以便获取详细信息

**优先级**：
- [x] P0 - 必须有

**实现细节**：
- 只显示近7天数据
- 按季度分组展示
- 显示股票代码、名称、预增幅度、公告日期
- 提供查看完整公告的链接
- 支持手动刷新

---

#### 功能 3：自动邮件通知
**描述**：定时检查新公告，发现新数据立即发送邮件通知，每日发送汇总。

**用户故事**：
- 作为订阅用户，我想要在有新公告时立即收到邮件，以便第一时间了解
- 作为订阅用户，我想要每天收到汇总邮件，以便回顾当日新增
- 作为用户，我想要邮件内容清晰美观，以便快速阅读

**优先级**：
- [x] P0 - 必须有

**实现细节**：
- 每5分钟检查一次新公告
- 发现新公告立即发送邮件
- 每天08:00发送汇总邮件
- 邮件模板美观、信息完整
- 避免重复发送

---

#### 功能 4：管理后台
**描述**：提供管理界面，查看统计数据、管理订阅、查看历史记录。

**用户故事**：
- 作为管理员，我想要看到订阅数量、股票数量等统计，以便了解系统状态
- 作为管理员，我想要查看所有历史数据，以便追溯和分析
- 作为管理员，我想要手动触发操作，以便测试和维护

**优先级**：
- [x] P1 - 应该有

**实现细节**：
- 数据统计面板
- 邮箱列表管理
- 股票历史数据查看
- 邮件发送历史
- 系统设置
- 手动操作按钮

---

#### 功能 5：在线人数统计
**描述**：右上角实时显示当前在线访问人数。

**用户故事**：
- 作为用户，我想要看到有多少人在线，以便了解系统活跃度

**优先级**：
- [x] P2 - 可以有

**实现细节**：
- 每个用户生成唯一ID
- 心跳机制（15秒）
- 30秒无心跳自动下线
- 右上角固定显示

---

### 2. 数据需求

#### 数据来源
- **数据源**：东方财富网公开 API
- **接口地址**：http://datacenter-web.eastmoney.com/api/data/v1/get
- **数据类型**：业绩预告数据
- **更新频率**：实时更新

#### 需要的数据字段
```typescript
interface EarningsReport {
  SECUCODE: string;           // 股票代码（带市场后缀）
  SECURITY_CODE: string;      // 纯股票代码
  SECURITY_NAME_ABBR: string; // 股票简称
  PREDICT_FINANCE_CODE: string; // 报告期代码
  REPORT_DATE: string;        // 公告日期
  PREDICT_TYPE: string;       // 预告类型（预增、略增等）
  CHANGE_RATIO_MIN: number;   // 变动幅度下限
  CHANGE_RATIO_MAX: number;   // 变动幅度上限
}

interface Stock {
  stockCode: string;
  stockName: string;
  reports: Array<{
    quarter: string;
    forecastType: string;
    changeMin: number;
    changeMax: number;
    reportDate: string;
  }>;
}
```

#### 数据过滤条件
- 预告类型：预增、略增、续盈、扭亏
- 报告期：2025年第3季度（Q3）
- 时间范围：近7天
- 去重规则：同一股票同一季度只保留最新一条

#### 数据更新频率
- 定时检查：每 5 分钟
- 即时通知：发现新数据立即处理
- 汇总通知：每天 08:00

---

### 3. 通知需求

#### 通知方式
- [x] 邮件通知

#### 通知时机
1. **即时通知**：发现新的业绩预增公告时立即发送
2. **每日汇总**：每天 08:00 发送当日新增汇总（如果有数据）

#### 通知内容

**即时通知邮件**：
- 邮件主题：`⚡ 业绩预增即时提醒 - 发现 X 只新股票`
- 邮件内容：
  - 新增股票数量
  - 每只股票的详细信息（代码、名称、预增幅度、报告期、公告日期）
  - 查看完整公告的链接
  - 数据来源说明
  - 推送时间

**每日汇总邮件**：
- 邮件主题：`📊 每日业绩预增汇总 - YYYY-MM-DD`
- 邮件内容：
  - 当日新增股票总数
  - 所有新增股票的详细信息
  - 数据统计
  - 查看详情链接

---

## 🎨 界面需求

### 1. 首页

#### 页面布局
- **顶部区域**：
  - 项目标题和图标
  - 项目说明
  - 右上角在线人数显示

- **左侧区域**（邮件订阅）：
  - 标题："邮件订阅"
  - 订阅邮箱数量显示
  - 邮箱输入框
  - 添加按钮
  - 已订阅邮箱列表（带删除按钮）
  - 自动通知说明

- **右侧区域**（今日新增）：
  - 标题："今日新增"
  - 刷新按钮
  - 按季度分组的股票列表
  - 每个股票卡片显示：
    - 股票名称和代码
    - 预增类型和幅度
    - 公告日期
    - 查看详情链接

- **底部区域**：
  - 数据来源说明
  - 更新频率说明
  - 管理后台入口链接

#### 核心组件
- 邮箱输入组件（带验证）
- 邮箱列表组件（带删除）
- 股票卡片组件
- 加载状态组件
- 空状态提示组件
- 在线人数显示组件

#### 响应式设计
- 移动端：单列布局
- 平板：双列布局
- 桌面：双列布局，更大间距

---

### 2. 管理后台

#### 功能模块
1. **数据统计面板**
   - 订阅邮箱数量
   - 预增股票数量
   - 发送历史数量
   - 卡片式展示

2. **标签页导航**
   - 邮箱列表
   - 预增股票
   - 发送历史

3. **邮箱列表标签页**
   - 显示所有订阅邮箱
   - 支持删除操作
   - 显示序号

4. **预增股票标签页**
   - 显示所有历史股票数据
   - 按季度分组
   - 显示详细信息

5. **发送历史标签页**
   - 显示所有邮件发送记录
   - 显示发送时间、收件人数量、股票数量、类型

6. **操作按钮区**
   - 初始化历史数据
   - 测试邮件发送
   - 刷新数据
   - 导出数据

7. **系统设置**
   - 通知频率设置

#### 权限要求
- [x] 公开访问（无需登录）

---

## 🔧 技术需求

### 1. 技术栈选择

#### 前端框架
- [x] Next.js 14 + React 18 + TypeScript

**原因**：
- 支持 SSR 和 SSG
- 内置 API Routes，前后端一体
- 优秀的性能和 SEO
- 易于部署到 Vercel
- TypeScript 提供类型安全

---

#### 样式方案
- [x] Tailwind CSS

**原因**：
- 快速开发
- 响应式设计简单
- 暗色模式支持
- 文件体积小
- 社区资源丰富

---

#### 图标库
- [x] Lucide React

**原因**：
- 图标丰富
- 体积小
- 易于使用
- 支持 Tree Shaking

---

#### 数据库
- [x] Upstash Redis (Serverless)

**原因**：
- 免费额度充足（10,000 命令/天）
- 无服务器，无需维护
- REST API，易于集成
- 低延迟
- 适合小型项目

---

#### 邮件服务
- [x] Nodemailer + SMTP

**原因**：
- 支持多种 SMTP 服务
- 配置简单
- 功能完善
- 免费使用

---

#### 部署平台
- [x] Vercel

**原因**：
- 与 Next.js 完美集成
- 自动部署
- 免费额度充足
- 支持 Cron Jobs
- 中国网络可访问
- 性能优秀

---

### 2. 定时任务需求

#### 任务 1：检查新公告
- **执行频率**：每 5 分钟（`*/5 * * * *`）
- **任务内容**：
  1. 从东方财富 API 获取最新数据
  2. 过滤近7天的数据
  3. 对比已发送记录
  4. 发现新数据发送邮件通知
  5. 更新已发送记录
- **失败处理**：
  - 记录错误日志
  - 下次继续尝试
  - 不影响其他功能

---

#### 任务 2：每日汇总
- **执行频率**：每天 00:00（`0 0 * * *`）
- **任务内容**：
  1. 统计当日新增股票
  2. 如果有新增，发送汇总邮件
  3. 记录发送历史
- **失败处理**：
  - 记录错误日志
  - 不影响即时通知

---

### 3. 第三方服务

#### 需要的服务
- [x] 邮件服务 (SMTP)

#### 服务配置
```env
# QQ 邮箱示例
SMTP_HOST=smtp.qq.com
SMTP_PORT=465
SMTP_USER=your@qq.com
SMTP_PASS=authorization-code  # 授权码，非密码
EMAIL_FROM=your@qq.com

# 163 邮箱示例
SMTP_HOST=smtp.163.com
SMTP_PORT=465
SMTP_USER=your@163.com
SMTP_PASS=authorization-code
EMAIL_FROM=your@163.com
```

---

## 📊 数据存储设计

### 1. 数据结构

#### 数据类型 1：邮件列表
```typescript
interface EmailList {
  emails: string[];
}
```

**存储方式**：
- Redis Key: `email_list`
- 数据类型: Array
- 过期时间: 永久

---

#### 数据类型 2：历史股票数据
```typescript
interface StockHistory {
  count: number;
  updatedAt: string;
  data: Stock[];
}
```

**存储方式**：
- Redis Key: `all_stocks_history`
- 数据类型: Object
- 过期时间: 永久

---

#### 数据类型 3：已发送股票记录
```typescript
type SentStocks = Set<string>; // 股票代码集合
```

**存储方式**：
- Redis Key: `sent_stocks`
- 数据类型: Set
- 过期时间: 永久

---

#### 数据类型 4：邮件发送历史
```typescript
interface EmailHistory {
  sentAt: string;
  recipients: string[];
  stockCount: number;
  type: 'instant' | 'daily';
}
```

**存储方式**：
- Redis Key: `email_history`
- 数据类型: Array
- 过期时间: 永久

---

#### 数据类型 5：在线用户
```typescript
interface OnlineUser {
  id: string;
  lastSeen: number;
}
```

**存储方式**：
- Redis Key: `online_users`
- 数据类型: Array
- 过期时间: 60 秒

---

#### 数据类型 6：系统设置
```typescript
interface AppSettings {
  notificationFrequency: number;
}
```

**存储方式**：
- Redis Key: `app_settings`
- 数据类型: Object
- 过期时间: 永久

---

#### 数据类型 7：缓存数据
```typescript
type CachedStocks = Stock[];
```

**存储方式**：
- Redis Key: `stocks_cache`
- 数据类型: Array
- 过期时间: 300 秒（5分钟）

---

### 2. 缓存策略

- **股票数据**：缓存 5 分钟，减少 API 调用
- **在线用户**：缓存 60 秒，自动清理过期用户
- **邮件列表**：不缓存，直接读取最新数据
- **历史数据**：不缓存，数据量不大

---

## 🔐 安全需求

### 1. 数据安全
- [x] 环境变量加密（Vercel 自动加密）
- [x] API 密钥保护（不提交到 Git）
- [x] 数据库访问控制（Upstash 提供）

### 2. 接口安全
- [x] Cron 任务鉴权（可选，使用 CRON_SECRET）
- [ ] API 限流（Vercel 自动提供）
- [x] CORS 配置（Next.js 默认配置）

### 3. 用户隐私
- 邮箱地址存储在 Redis，不对外暴露
- 不收集用户其他信息
- 支持用户自主删除邮箱

---

## 📈 性能需求

### 1. 响应时间
- 页面加载：< 2 秒
- API 响应：< 500ms
- 数据更新：每 5 分钟

### 2. 并发处理
- 预计同时在线用户：50-100 人
- 预计每日请求量：5,000-10,000 次

### 3. 数据量
- 预计股票数据总量：500-1000 条
- 预计订阅邮箱数量：10-50 个
- 数据增长速度：每天 5-20 条新公告

---

## 🎯 成功指标

### 1. 功能指标
- [x] 所有核心功能正常运行
- [x] 数据更新及时准确（5分钟延迟内）
- [x] 通知发送成功率 > 95%

### 2. 性能指标
- [x] 页面加载时间 < 2秒
- [x] API 响应时间 < 500ms
- [x] 系统可用性 > 99%

### 3. 用户指标
- [ ] 订阅用户数 > 10
- [ ] 用户满意度 > 90%
- [ ] 邮件打开率 > 50%

---

## 📅 开发计划

### 第一阶段：MVP（最小可行产品）✅ 已完成
**时间**：1 周

**功能清单**：
- [x] 基础数据展示
- [x] 邮件订阅功能
- [x] 定时数据更新
- [x] 即时邮件通知
- [x] 数据持久化

---

### 第二阶段：完善功能 ✅ 已完成
**时间**：1 周

**功能清单**：
- [x] 管理后台
- [x] 数据统计
- [x] 邮件模板优化
- [x] 在线人数统计
- [x] 响应式设计优化

---

### 第三阶段：优化和扩展 🔄 进行中
**时间**：持续

**功能清单**：
- [x] 性能优化
- [x] 完整文档编写
- [ ] 新增通知方式（微信）
- [ ] 数据可视化图表
- [ ] 用户自定义筛选

---

## 🚀 部署需求

### 1. 部署环境
- [x] 生产环境（Vercel）
- [ ] 测试环境
- [x] 开发环境（本地）

### 2. 域名需求
- [x] 使用 Vercel 提供的域名
- [ ] 自定义域名（可选）

### 3. 监控需求
- [x] 错误日志监控（Vercel Logs）
- [x] 性能监控（Vercel Analytics）
- [ ] 用户行为分析（可选）

---

## 📝 文档需求

### 需要的文档
- [x] README.md - 项目介绍
- [x] QUICK_START.md - 快速开始指南
- [x] PROJECT_ARCHITECTURE.md - 项目架构文档
- [x] REUSABLE_TEMPLATE.md - 复用模板
- [x] TECH_STACK_REFERENCE.md - 技术栈速查
- [x] DEPLOYMENT_CHECKLIST.md - 部署清单
- [x] UPSTASH_SETUP.md - Upstash 配置
- [x] EMAIL_CONFIG.md - 邮件配置
- [x] DOCUMENTATION_INDEX.md - 文档索引
- [x] REQUIREMENTS.md - 需求文档（本文档）

---

## 🔄 后续迭代计划

### 短期优化（1-2周）
- [ ] 添加数据筛选功能（按预增幅度、股票代码等）
- [ ] 优化邮件模板（更美观、更多信息）
- [ ] 添加股票收藏功能
- [ ] 提升页面加载速度

---

### 中期规划（1-3个月）
- [ ] 添加微信通知（企业微信机器人）
- [ ] 支持自定义筛选条件（用户设置）
- [ ] 添加数据可视化图表（趋势分析）
- [ ] 添加用户登录系统
- [ ] 支持多种报告期（Q1、Q2、Q4）

---

### 长期愿景（3个月+）
- [ ] 支持多种数据源（不同财经网站）
- [ ] 开发移动端 App
- [ ] 添加 AI 智能推荐
- [ ] 社区功能（用户评论、分享）
- [ ] 付费订阅（高级功能）
- [ ] 开放 API

---

## ✅ 验收标准

### 功能验收
- [x] 所有 P0 功能已实现
- [x] 所有 P1 功能已实现
- [x] 核心流程测试通过
- [x] 邮件发送功能正常
- [x] 数据更新及时准确

### 性能验收
- [x] 响应时间符合要求
- [x] 并发处理符合要求
- [x] 无明显性能瓶颈
- [x] 缓存策略有效

### 质量验收
- [x] 代码规范符合 TypeScript 标准
- [x] 无严重 Bug
- [x] 文档完整详细
- [x] 响应式设计良好

---

## 📞 联系方式

**项目负责人**：geooooooorge  
**GitHub**：https://github.com/geooooooorge/yjyg

---

## 📄 附录

### 参考资料
- [东方财富业绩预告接口](http://datacenter-web.eastmoney.com/api/data/v1/get)
- [Next.js 官方文档](https://nextjs.org/docs)
- [Upstash Redis 文档](https://docs.upstash.com/redis)
- [Vercel 部署文档](https://vercel.com/docs)

### 术语表
| 术语 | 解释 |
|------|------|
| 业绩预增 | 上市公司预告业绩将比上年同期增长 |
| Q3 | 第三季度（7-9月） |
| SMTP | 简单邮件传输协议 |
| Cron | 定时任务调度器 |
| SSR | 服务器端渲染 |
| API Routes | Next.js 的后端 API 路由 |
| Redis | 内存数据库 |

---

**文档版本**：v1.0  
**创建日期**：2025-10-28  
**最后更新**：2025-10-28  
**更新人**：geooooooorge

---

## 📊 项目状态

**当前版本**：v1.0  
**开发状态**：✅ 已完成 MVP 和核心功能  
**部署状态**：✅ 已部署到 Vercel  
**文档状态**：✅ 文档完整

**下一步计划**：持续优化和功能扩展
